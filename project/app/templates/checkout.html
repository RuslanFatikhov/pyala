{% extends "base.html" %}

{% block title %}Оформление заказа - Керамические пиалы{% endblock %}

{% block content %}
<div class="container">
    <h1>Оформление заказа</h1>
    
    <div class="checkout-layout">
        <div class="checkout-form">
            <form method="POST">
                <div class="form-group">
                    <label for="name">Имя *</label>
                    <input type="text" id="name" name="name" 
                           value="{{ form_data.name if form_data else '' }}" 
                           required maxlength="60">
                    {% if errors and errors.name %}
                        <div class="error">{{ errors.name }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="phone">Телефон *</label>
                    <input type="tel" id="phone" name="phone" 
                           value="{{ form_data.phone if form_data else '' }}" 
                           required placeholder="+7 (000) 000-00-00">
                    {% if errors and errors.phone %}
                        <div class="error">{{ errors.phone }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="city">Город *</label>
                    <input type="text" id="city" name="city" 
                           value="{{ form_data.city if form_data else '' }}" 
                           required maxlength="100">
                    {% if errors and errors.city %}
                        <div class="error">{{ errors.city }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="address">Адрес доставки *</label>
                    <textarea id="address" name="address" 
                              required maxlength="200" rows="3">{{ form_data.address if form_data else '' }}</textarea>
                    {% if errors and errors.address %}
                        <div class="error">{{ errors.address }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="comment">Комментарий к заказу</label>
                    <textarea id="comment" name="comment" 
                              maxlength="500" rows="3" placeholder="Особые пожелания, время доставки...">{{ form_data.comment if form_data else '' }}</textarea>
                    {% if errors and errors.comment %}
                        <div class="error">{{ errors.comment }}</div>
                    {% endif %}
                </div>
                
                <button type="submit" class="btn btn-primary btn-large">
                    Подтвердить заказ
                </button>
            </form>
        </div>
        
        <div class="order-summary">
            <h3>Ваш заказ</h3>
            {% set total = 0 %}
            {% for item in cart_items %}
                <div class="summary-item">
                    <span class="item-name">{{ item.product.title }}</span>
                    <span class="item-qty">x{{ item.qty }}</span>
                    <span class="item-price">{{ item.total }} {{ config.get('CURRENCY', 'RUB') }}</span>
                </div>
                {% set total = total + item.total %}
            {% endfor %}
            
            <div class="summary-total">
                <strong>Итого: {{ total }} {{ config.get('CURRENCY', 'RUB') }}</strong>
            </div>
            
            <div class="delivery-info">
                <h4>Информация о доставке</h4>
                <ul>
                    <li>Доставка 3-7 рабочих дней</li>
                    <li>Бесплатная доставка от 5000 {{ config.get('CURRENCY', 'RUB') }}</li>
                    <li>Оплата при получении</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Аналитика: начало оформления заказа
    gtag && gtag('event', 'begin_checkout', {
        currency: '{{ config.get("CURRENCY", "RUB") }}',
        value: {{ cart_items|sum(attribute='total') }},
        items: [
            {% for item in cart_items %}
            {
                item_id: '{{ item.product.sku }}',
                item_name: '{{ item.product.title }}',
                category: '{{ item.product.category }}',
                price: {{ item.product.price }},
                quantity: {{ item.qty }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    });

    // Аналитика при отправке формы
    document.querySelector('form').addEventListener('submit', function() {
        gtag && gtag('event', 'purchase_submit', {
            currency: '{{ config.get("CURRENCY", "RUB") }}',
            value: {{ cart_items|sum(attribute='total') }}
        });
    });
</script>
{% endblock %}