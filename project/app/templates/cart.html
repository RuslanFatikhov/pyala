{% extends "base.html" %}

{% block title %}Корзина - Керамические пиалы{% endblock %}

{% block content %}
<div class="container">
    <h1>Корзина</h1>
    
    {% if cart_items %}
        <div class="cart-items">
            {% set total = 0 %}
            {% for item in cart_items %}
                <div class="cart-item" data-sku="{{ item.product.sku }}">
                    <div class="item-image">
                        {% if item.product.images %}
                            <img src="{{ item.product.images[0] }}" alt="{{ item.product.title }}">
                        {% else %}
                            <div class="no-image">Нет фото</div>
                        {% endif %}
                    </div>
                    
                    <div class="item-info">
                        <h3>{{ item.product.title }}</h3>
                        <p class="item-price">{{ item.product.price }} {{ config.get('CURRENCY', 'RUB') }}</p>
                        {% if item.product.volume_ml %}
                            <p class="item-volume">Объем: {{ item.product.volume_ml }} мл</p>
                        {% endif %}
                    </div>
                    
                    <div class="item-quantity">
                        <label>Количество:</label>
                        <div class="quantity-controls">
                            <button onclick="updateQuantity('{{ item.product.sku }}', {{ item.qty - 1 }})">-</button>
                            <span class="quantity">{{ item.qty }}</span>
                            <button onclick="updateQuantity('{{ item.product.sku }}', {{ item.qty + 1 }})">+</button>
                        </div>
                    </div>
                    
                    <div class="item-total">
                        <span class="total-price">{{ item.total }} {{ config.get('CURRENCY', 'RUB') }}</span>
                        <button class="btn-remove" onclick="removeFromCart('{{ item.product.sku }}')">Удалить</button>
                    </div>
                </div>
                {% set total = total + item.total %}
            {% endfor %}
        </div>
        
        <div class="cart-summary">
            <div class="summary-row">
                <span>Итого:</span>
                <span class="total-amount">{{ total }} {{ config.get('CURRENCY', 'RUB') }}</span>
            </div>
            <a href="{{ url_for('public.checkout') }}" class="btn btn-primary btn-large">
                Оформить заказ
            </a>
            <a href="{{ url_for('public.catalog') }}" class="btn btn-outline">
                Продолжить покупки
            </a>
        </div>
    {% else %}
        <div class="empty-cart">
            <p>Ваша корзина пуста</p>
            <a href="{{ url_for('public.catalog') }}" class="btn btn-primary">Перейти в каталог</a>
        </div>
    {% endif %}
</div>

<script>
    function updateQuantity(sku, newQty) {
        if (newQty < 1) {
            removeFromCart(sku);
            return;
        }
        
        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sku: sku,
                qty: newQty
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                location.reload(); // Простое обновление страницы
            } else {
                showNotification(data.error, 'error');
            }
        });
    }
    
    function removeFromCart(sku) {
        if (!confirm('Удалить товар из корзины?')) {
            return;
        }
        
        fetch('/cart/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sku: sku
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                location.reload();
                updateCartCounter();
            } else {
                showNotification(data.error, 'error');
            }
        });
    }
</script>
{% endblock %}