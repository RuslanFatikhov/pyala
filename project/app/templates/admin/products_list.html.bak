<!-- app/templates/admin/products_list.html -->
{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏{% endblock %}

{% block content %}
<div class="admin-header-section">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin.product_create') }}" class="btn btn-primary">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
        <a href="{{ url_for('admin.upload_products') }}" class="btn btn-outline">
            üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV
        </a>
        <a href="{{ url_for('admin.download_products') }}" class="btn btn-outline">
            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-section">
    <form method="GET" class="filters-form">
        <div class="filter-group">
            <input type="text" name="search" value="{{ search }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, SKU, –æ–ø–∏—Å–∞–Ω–∏—é..." class="search-input">
        </div>
        
        <div class="filter-group">
            <select name="category" class="filter-select">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>
                        {{ cat }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-secondary">–ù–∞–π—Ç–∏</button>
            <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline btn-small">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<div class="results-info">
    <p>–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>{{ total }}</strong></p>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
{% if products %}
    <div class="products-table-container">
        <table class="products-table">
            <thead>
                <tr>
                    <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                    <th>SKU</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–û–±—ä–µ–º</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td class="product-image-cell">
                        {% if product.images and product.images[0] %}
                            <img src="{{ product.images[0] }}" alt="{{ product.title }}" class="product-thumbnail">
                        {% else %}
                            <div class="product-no-image">üì¶</div>
                        {% endif %}
                    </td>
                    <td>
                        <code>{{ product.sku }}</code>
                    </td>
                    <td>
                        <strong>{{ product.title }}</strong>
                        {% if product.description %}
                            <br><small class="text-muted">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="category-badge">{{ product.category or '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }}</span>
                    </td>
                    <td>
                        {% if product.volume_ml %}
                            {{ product.volume_ml }} –º–ª
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="price">{{ "{:,.0f}".format(product.price) }} ‚Ç∏</span>
                        {% if product.old_price %}
                            <br><span class="old-price">{{ "{:,.0f}".format(product.old_price) }} ‚Ç∏</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="stock {% if product.stock <= 0 %}stock-zero{% elif product.stock <= 5 %}stock-low{% endif %}">
                            {{ product.stock }}
                        </span>
                    </td>
                    <td>
                        {% if product.is_active %}
                            <span class="status-active">‚úì –ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                            <span class="status-inactive">‚úó –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <a href="{{ url_for('admin.product_edit', sku=product.sku) }}" 
                               class="btn btn-small btn-outline" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </a>
                            <form method="POST" action="{{ url_for('admin.product_duplicate', sku=product.sku) }}" 
                                  style="display: inline;">
                                <button type="submit" class="btn btn-small btn-secondary" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">
                                    üìã
                                </button>
                            </form>
                            <button onclick="deleteProduct('{{ product.sku }}', '{{ product.title }}')" 
                                    class="btn btn-small btn-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
                <a href="{{ url_for('admin.products_list', page=page-1, search=search, category=category_filter) }}" 
                   class="btn btn-outline btn-small">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            {% endif %}
            
            <span class="pagination-info">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}
            </span>
            
            {% if page < total_pages %}
                <a href="{{ url_for('admin.products_list', page=page+1, search=search, category=category_filter) }}" 
                   class="btn btn-outline btn-small">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
            {% endif %}
        </div>
    {% endif %}

{% else %}
    <div class="empty-state">
        <p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% if search or category_filter %}
            <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
        {% else %}
            <a href="{{ url_for('admin.product_create') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</a>
        {% endif %}
    </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä <strong id="deleteProductName"></strong>?</p>
        <p class="text-danger">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div class="modal-actions">
            <button onclick="confirmDelete()" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="closeDeleteModal()" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
let deleteProductSku = null;

function deleteProduct(sku, title) {
    deleteProductSku = sku;
    document.getElementById('deleteProductName').textContent = title;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteProductSku = null;
}

function confirmDelete() {
    if (!deleteProductSku) return;
    
    fetch(`/admin/products/${deleteProductSku}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
    })
    .finally(() => {
        closeDeleteModal();
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
window.onclick = function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
}
</script>
{% endblock %}

<!-- app/templates/admin/product_edit.html -->
{% extends "admin/base.html" %}

{% block title %}
    {% if is_create %}–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞{% endif %}
{% endblock %}

{% block content %}
<div class="admin-header-section">
    <h1>
        {% if is_create %}
            –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        {% else %}
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: {{ product.title }}
        {% endif %}
    </h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>

<form method="POST" class="product-form">
    <div class="form-grid">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="form-section">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            
            <div class="form-group">
                <label for="sku">SKU <span class="required">*</span></label>
                <input type="text" id="sku" name="sku" 
                       value="{{ form_data.get('sku', '') }}" 
                       {% if not is_create %}readonly{% endif %}
                       class="form-input {% if errors.get('sku') %}error{% endif %}"
                       required>
                {% if errors.get('sku') %}
                    <div class="error-message">{{ errors.sku }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="required">*</span></label>
                <input type="text" id="title" name="title" 
                       value="{{ form_data.get('title', '') }}"
                       class="form-input {% if errors.get('title') %}error{% endif %}"
                       required>
                {% if errors.get('title') %}
                    <div class="error-message">{{ errors.title }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" 
                          class="form-textarea"
                          rows="4">{{ form_data.get('description', '') }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <input type="text" id="category" name="category" 
                       value="{{ form_data.get('category', '') }}"
                       class="form-input"
                       list="categories-list">
                <datalist id="categories-list">
                    {% for cat in categories %}
                        <option value="{{ cat }}">
                    {% endfor %}
                </datalist>
            </div>
        </div>
        
        <!-- –¶–µ–Ω—ã –∏ –æ—Å—Ç–∞—Ç–∫–∏ -->
        <div class="form-section">
            <h3>–¶–µ–Ω–∞ –∏ –æ—Å—Ç–∞—Ç–∫–∏</h3>
            
            <div class="form-group">
                <label for="price">–¶–µ–Ω–∞ <span class="required">*</span></label>
                <input type="number" id="price" name="price" 
                       value="{{ form_data.get('price', '') }}"
                       class="form-input {% if errors.get('price') %}error{% endif %}"
                       min="0" step="0.01" required>
                {% if errors.get('price') %}
                    <div class="error-message">{{ errors.price }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="old_price">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label>
                <input type="number" id="old_price" name="old_price" 
                       value="{{ form_data.get('old_price', '') }}"
                       class="form-input {% if errors.get('old_price') %}error{% endif %}"
                       min="0" step="0.01">
                {% if errors.get('old_price') %}
                    <div class="error-message">{{ errors.old_price }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="stock">–û—Å—Ç–∞—Ç–æ–∫</label>
                <input type="number" id="stock" name="stock" 
                       value="{{ form_data.get('stock', 0) }}"
                       class="form-input {% if errors.get('stock') %}error{% endif %}"
                       min="0">
                {% if errors.get('stock') %}
                    <div class="error-message">{{ errors.stock }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
        <div class="form-section">
            <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
            
            <div class="form-group">
                <label for="volume_ml">–û–±—ä–µ–º (–º–ª)</label>
                <input type="number" id="volume_ml" name="volume_ml" 
                       value="{{ form_data.get('volume_ml', '') }}"
                       class="form-input {% if errors.get('volume_ml') %}error{% endif %}"
                       min="0">
                {% if errors.get('volume_ml') %}
                    <div class="error-message">{{ errors.volume_ml }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="color">–¶–≤–µ—Ç</label>
                <input type="text" id="color" name="color" 
                       value="{{ form_data.get('color', '') }}"
                       class="form-input"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–ª—ã–π, –∑–µ–ª—ë–Ω—ã–π">
            </div>
            
            <div class="form-group">
                <label for="is_active">–°—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä–∞</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="is_active" name="is_active" 
                               {% if form_data.get('is_active', True) %}checked{% endif %}>
                        –¢–æ–≤–∞—Ä –∞–∫—Ç–∏–≤–µ–Ω (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div class="form-section">
            <h3>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
            
            <div class="form-group">
                <label for="images">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <textarea id="images" name="images" 
                          class="form-textarea"
                          rows="3"
                          placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ | –∏–ª–∏ –∑–∞–ø—è—Ç—ã–º–∏">{{ form_data.get('images', '') }}</textarea>
                <div class="form-help">
                    –í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª–æ–º | –∏–ª–∏ –∑–∞–ø—è—Ç—ã–º–∏
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">
            {% if is_create %}–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% endif %}
        </button>
        <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</a>
        
        {% if not is_create %}
            <form method="POST" action="{{ url_for('admin.product_duplicate', sku=product.sku) }}" 
                  style="display: inline;" onsubmit="return confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —Ç–æ–≤–∞—Ä–∞?')">
                <button type="submit" class="btn btn-secondary">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            </form>
        {% endif %}
    </div>
</form>

<script>
// –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è SKU –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
{% if is_create %}
document.getElementById('title').addEventListener('input', function() {
    const title = this.value;
    const skuField = document.getElementById('sku');
    
    if (title && !skuField.dataset.manuallyEdited) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SKU –∏–∑ –ø–µ—Ä–≤—ã—Ö –±—É–∫–≤ —Å–ª–æ–≤
        const words = title.toUpperCase().split(' ');
        let sku = words.slice(0, 3).map(word => word.substr(0, 3)).join('');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤–æ–π —Å—É—Ñ—Ñ–∏–∫—Å
        sku += '-001';
        
        skuField.value = sku;
    }
});

document.getElementById('sku').addEventListener('input', function() {
    this.dataset.manuallyEdited = 'true';
});
{% endif %}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
document.getElementById('images').addEventListener('input', function() {
    const urls = this.value.split(/[,\n]/).map(url => url.trim()).filter(url => url);
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    const existingPreview = document.querySelector('.images-preview');
    if (existingPreview) {
        existingPreview.remove();
    }
    
    if (urls.length > 0) {
        const preview = document.createElement('div');
        preview.className = 'images-preview';
        preview.innerHTML = '<h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:</h4>';
        
        urls.forEach((url, index) => {
            if (index < 5) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                const img = document.createElement('img');
                img.src = url;
                img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; margin: 5px; border: 1px solid #ddd;';
                img.onerror = function() {
                    this.style.display = 'none';
                };
                preview.appendChild(img);
            }
        });
        
        this.parentNode.appendChild(preview);
    }
});
</script>
{% endblock %}