<!-- app/templates/admin/products_list.html -->
{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏{% endblock %}

{% block content %}
<div class="admin-header-section">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin.product_create') }}" class="btn btn-primary">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
        <a href="{{ url_for('admin.upload_products') }}" class="btn btn-outline">
            üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV
        </a>
        <a href="{{ url_for('admin.download_products') }}" class="btn btn-outline">
            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-section">
    <form method="GET" class="filters-form">
        <div class="filter-group">
            <input type="text" name="search" value="{{ search }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, SKU, –æ–ø–∏—Å–∞–Ω–∏—é..." class="search-input">
        </div>
        
        <div class="filter-group">
            <select name="category" class="filter-select">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>
                        {{ cat }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-secondary">–ù–∞–π—Ç–∏</button>
            <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline btn-small">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<div class="results-info">
    <p>–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>{{ total }}</strong></p>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
{% if products %}
    <div class="products-table-container">
        <table class="products-table">
            <thead>
                <tr>
                    <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                    <th>SKU</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–û–±—ä–µ–º</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td class="product-image-cell">
                        {% if product.images and product.images[0] %}
                            <img src="{{ product.images[0] }}" alt="{{ product.title }}" class="product-thumbnail">
                        {% else %}
                            <div class="product-no-image">üì¶</div>
                        {% endif %}
                    </td>
                    <td>
                        <code>{{ product.sku }}</code>
                    </td>
                    <td>
                        <strong>{{ product.title }}</strong>
                        {% if product.description %}
                            <br><small class="text-muted">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="category-badge">{{ product.category or '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }}</span>
                    </td>
                    <td>
                        {% if product.volume_ml %}
                            {{ product.volume_ml }} –º–ª
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="price">{{ "{:,.0f}".format(product.price) }} ‚Ç∏</span>
                        {% if product.old_price %}
                            <br><span class="old-price">{{ "{:,.0f}".format(product.old_price) }} ‚Ç∏</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="stock {% if product.stock <= 0 %}stock-zero{% elif product.stock <= 5 %}stock-low{% endif %}">
                            {{ product.stock }}
                        </span>
                    </td>
                    <td>
                        {% if product.is_active %}
                            <span class="status-active">‚úì –ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                            <span class="status-inactive">‚úó –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <a href="{{ url_for('admin.product_edit', sku=product.sku) }}" 
                               class="btn btn-small btn-outline" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </a>
                            <form method="POST" action="{{ url_for('admin.product_duplicate', sku=product.sku) }}" 
                                  style="display: inline;">
                                <button type="submit" class="btn btn-small btn-secondary" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">
                                    üìã
                                </button>
                            </form>
                            <button onclick="deleteProduct('{{ product.sku }}', '{{ product.title }}')" 
                                    class="btn btn-small btn-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
                <a href="{{ url_for('admin.products_list', page=page-1, search=search, category=category_filter) }}" 
                   class="btn btn-outline btn-small">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            {% endif %}
            
            <span class="pagination-info">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}
            </span>
            
            {% if page < total_pages %}
                <a href="{{ url_for('admin.products_list', page=page+1, search=search, category=category_filter) }}" 
                   class="btn btn-outline btn-small">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
            {% endif %}
        </div>
    {% endif %}

{% else %}
    <div class="empty-state">
        <p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% if search or category_filter %}
            <a href="{{ url_for('admin.products_list') }}" class="btn btn-outline">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
        {% else %}
            <a href="{{ url_for('admin.product_create') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</a>
        {% endif %}
    </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä <strong id="deleteProductName"></strong>?</p>
        <p class="text-danger">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div class="modal-actions">
            <button onclick="confirmDelete()" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="closeDeleteModal()" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
let deleteProductSku = null;

function deleteProduct(sku, title) {
    deleteProductSku = sku;
    document.getElementById('deleteProductName').textContent = title;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteProductSku = null;
}

function confirmDelete() {
    if (!deleteProductSku) return;
    
    fetch(`/admin/products/${deleteProductSku}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
    })
    .finally(() => {
        closeDeleteModal();
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
window.onclick = function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
}
</script>
{% endblock %}

<!-- app/templates/admin/product_edit.html -->
