{% extends "base.html" %}

{% block title %}Каталог - Керамические пиалы{% endblock %}

{% block content %}
<div class="container">
    <span class="catalog-header">
        <h1>Каталог товаров</h1>
    </span>
    
    <!-- Товары по категориям -->
    {% if products %}
        {% if filters.category %}
            <!-- Если выбрана конкретная категория - показываем как обычно -->
            <div class="products-grid">
                {% for product in products %}
                    <div class="product-card">
                        <a href="{{ url_for('public.product_detail', sku=product.sku) }}">
                            {% set product_imgs = product_images(product.sku, 2) %}
                            {% if product_imgs and product_imgs|length > 0 and not product_imgs[0].endswith('no-image.jpg') %}
                                {% set main_image = product_imgs[0] %}
                                {% set hover_image = product_imgs[1] if product_imgs|length > 1 else product_imgs[0] %}
                                
                                <div class="product-image">
                                    <img class="main-image"
                                       src="{{ main_image }}"
                                       alt="{{ product.title }}"
                                       loading="lazy">
                                    <img class="secondary-image"
                                       src="{{ hover_image }}"
                                       alt="{{ product.title }}"
                                       loading="lazy">
                                </div>
                            {% else %}
                                <div class="product-image">
                                    <img class="main-image"
                                       src="/static/img/goods/no-image.jpg"
                                       alt="Изображение недоступно"
                                       loading="lazy">
                                </div>
                            {% endif %}
                            <h3>{{ product.title }}</h3>
                            <div class="price">
                                <span class="current-price">{{ product.price }} {{ config.get('CURRENCY', '₽') }}</span>
                                {% if product.old_price %}
                                    <span class="old-price">{{ product.old_price }} {{ config.get('CURRENCY', '₽') }}</span>
                                {% endif %}
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Если категория не выбрана - группируем по категориям -->
            {% for category in categories %}
                {% set category_products = products | selectattr('category', 'equalto', category) | list %}
                {% if category_products %}
                    <div class="category-section">
                        <div class="category-header">
                            <h2 class="color-1">{{ category.title() }}</h2>
                        </div>
                        
                        <div class="products-grid">
                            {% for product in category_products[:4] %}
                                <div class="product-card">
                                    <a href="{{ url_for('public.product_detail', sku=product.sku) }}">
                                        {% set product_imgs = product_images(product.sku, 2) %}
                                        {% if product_imgs and product_imgs|length > 0 and not product_imgs[0].endswith('no-image.jpg') %}
                                            {% set main_image = product_imgs[0] %}
                                            {% set hover_image = product_imgs[1] if product_imgs|length > 1 else product_imgs[0] %}
                                            
                                            <div class="product-image">
                                                <img class="main-image"
                                                   src="{{ main_image }}"
                                                   alt="{{ product.title }}"
                                                   loading="lazy">
                                                <img class="secondary-image"
                                                   src="{{ hover_image }}"
                                                   alt="{{ product.title }}"
                                                   loading="lazy">
                                            </div>
                                        {% else %}
                                            <div class="product-image">
                                                <img class="main-image"
                                                   src="/static/img/goods/no-image.jpg"
                                                   alt="Изображение недоступно"
                                                   loading="lazy">
                                            </div>
                                        {% endif %}
                                        <h3>{{ product.title }}</h3>
                                        <div class="price">
                                            <span class="current-price">{{ product.price }} {{ config.get('CURRENCY', '₽') }}</span>
                                            {% if product.old_price %}
                                                <span class="old-price">{{ product.old_price }} {{ config.get('CURRENCY', '₽') }}</span>
                                            {% endif %}
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% else %}
        <div class="no-products">
            <p>Товары не найдены</p>
            <a href="{{ url_for('public.catalog') }}" class="btn btn-primary">Посмотреть все товары</a>
        </div>
    {% endif %}
    
    <!-- Пагинация (только если выбрана конкретная категория) -->
    {% if filters.category and total_pages > 1 %}
        <div class="pagination">
            {% for page in range(1, total_pages + 1) %}
                {% if page == current_page %}
                    <span class="page-current">{{ page }}</span>
                {% else %}
                    <a href="{{ url_for('public.catalog', page=page, **filters) }}" class="page-link">{{ page }}</a>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}